{% extends '@App/base.html.twig' %}

{% block body %}
    <p>This page will be used by the admin to create users and change privileges.</p>

    <!-- Nav tabs -->
    <ul class="nav nav-tabs" role="tablist">
        <li class="nav-item">
            <a class="nav-link active" data-toggle="tab" href="#view" role="tab">View</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" data-toggle="tab" href="#create" role="tab">Create</a>
        </li>
    </ul>

    <br/>

    <!-- Tab panes -->
    <div class="tab-content">

        <div class="tab-pane active" id="view" role="tabpanel">
            <table id="patients" class="table table-striped table-bordered" cellspacing="0">
                <thead>
                <tr>
                    {#<th>ID</th>#}
                    <th>Username</th>
                    <th>First Name</th>
                    <th>Last Name</th>
                    <th>Manage</th>
                </tr>
                </thead>
                <tfoot>
                <tr>
                    {#<th>ID</th>#}
                    <th>Username</th>
                    <th>First Name</th>
                    <th>Last Name</th>
                    <th>Manage</th>
                </tr>
                </tfoot>
                <tbody>
                {% for user in users %}
                    <tr>
                        {#<td>{{ patient.id }}</td>#}
                        <td>{{ user.username }}</td>
                        <td></td>
                        <td></td>
                        <td>
                            <!-- Example split danger button -->
                            <div class="btn-group">
                                <a role="button" class="btn btn-primary" href="admin/user/{{ user.username }}">View</a>
                                <button type="button" class="btn btn-primary dropdown-toggle dropdown-toggle-split"
                                        data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                    <span class="sr-only">Toggle Dropdown</span>
                                </button>
                                <div class="dropdown-menu">
                                    <h6 class="dropdown-header">View</h6>
                                    <a class="dropdown-item" href="#">Authored Notes</a>
                                    <a class="dropdown-item" href="#">Reviewed Notes</a>
                                    <div class="dropdown-divider"></div>
                                    <h6 class="dropdown-header">Danger Zone</h6>
                                    <a class="dropdown-item confirm-link text-warning"
                                       data-confirm-title="Archive User"
                                       data-confirm-message="Are you sure you wish to <b>archive</b> {{ user.username }}"
                                       data-bootstrap-color="warning"
                                       data-link="/admin/archive/{{ user.username }}">Archive</a>
                                    <a class="dropdown-item confirm-link text-danger"
                                       data-confirm-title="Delete User"
                                       data-confirm-message="Are you sure you wish to <b>delete</b> {{ user.username }}"
                                       data-bootstrap-color="danger"
                                       data-link="/admin/delete/{{ user.username }}">Delete</a>
                                </div>
                            </div>
                        </td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Begin Add User Form -->
        <div class="tab-pane fade" id="create" role="tabpanel">
            <p>Below is the form for creating users. Can only be accessed by the Administrator Role.</p>
            {{ form_start(form, { 'attr': {'class': 'container form'} }) }}

            <div class="row">
                <div class="form-group col-sm-6">
                    {{ form_label(form.username, null, { 'attr': {'class': 'col-form-label'} }) }}
                    {{ form_errors(form.username) }}
                    {{ form_widget(form.username, { 'attr': {'class': 'form-control'} }) }}
                </div>

                <div class="form-group col-sm-6">
                    {{ form_label(form.email, null, { 'attr': {'class': 'col-form-label'} }) }}
                    {{ form_errors(form.email) }}
                    {{ form_widget(form.email, { 'attr': {'class': 'form-control'} }) }}
                </div>
            </div>

            <div class="row">
                <div class="form-group col-sm-6">
                    {{ form_label(form.plainPassword.first, null, { 'attr': {'class': 'col-form-label'} }) }}
                    {{ form_errors(form.plainPassword.first) }}
                    {{ form_widget(form.plainPassword.first, { 'attr': {'class': 'form-control'} }) }}
                </div>

                <div class="form-group col-sm-6">
                    {{ form_label(form.plainPassword.second, null, { 'attr': {'class': 'col-form-label'} }) }}
                    {{ form_errors(form.plainPassword.second) }}
                    {{ form_widget(form.plainPassword.second, { 'attr': {'class': 'form-control'} }) }}
                </div>
            </div>

            <div class="row">
                <div class="form-group col-sm-12">
                    {{ form_label(form.roles, null, { 'attr': {'class': 'col-form-label'} }) }}
                    {{ form_errors(form.roles) }}
                    {{ form_widget(form.roles, { 'attr': {'class': 'form-control'} }) }}
                </div>
            </div>


            <button type="submit">Register!</button>
            {{ form_end(form) }}
            <!-- End Add Patient Form -->
        </div>
    </div>


    <!-- Modals -->
    <div class="modal fade" id="confirmModal">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Confirmation Dialog</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <br/>
                    <div class="alert alert-warning" role="alert">
                        {#<strong>Confirmation: </strong>#}
                        <span class="warning-message">
                            Are you sure you wish to do that?
                        </span>
                    </div>
                </div>
                <div class="modal-footer">
                    <a href="#" class="btn btn-warning confirm">Archive Patient</a>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block javascripts %}
    <link rel="stylesheet" href="https://cdn.datatables.net/1.10.16/css/dataTables.bootstrap4.min.css">
    <script src="//cdn.datatables.net/1.10.16/js/jquery.dataTables.min.js"></script>
    <script src="//cdn.datatables.net/1.10.16/js/dataTables.bootstrap4.min.js"></script>
    <script>
        $(document).ready(function () {
            $('#patients').DataTable();
            $('[data-toggle="tooltip"]').tooltip()
        });
    </script>

    <!--Modal-->
    <script>

        //When clicked
        $('.confirm-link').on('click', function (e) {
            //e.preventDefault();

            //Pass data to shown handler
            var link = $(this).data('link');
            var confirmTitle = $(this).data('confirm-title');
            var confirmMessage = $(this).data('confirm-message');
            var bootstrapColor = $(this).data('bootstrap-color');

            var modal = $('#confirmModal');

            modal.find('.modal-title').html(confirmTitle);
            modal.find('.warning-message').html(confirmMessage);
            modal.find('.confirm').attr('class', 'btn confirm  btn-' + bootstrapColor);
            modal.find('.alert.alert-warning').attr('class', 'alert alert-' + bootstrapColor);
            modal.data({
                'link': link
            }).modal('show');
        });

        $('#confirmModal .confirm').click(function () {
            // handle redirect here
            var link = $('#confirmModal').data('link');
            location.href = link;
            $('#confirmModal').modal('hide');
        });

        // Javascript to enable link to tab
        var url = document.location.toString();
        if (url.match('#') && !url.match('#view')) {
            $('.tab-pane.active').removeClass('active');
            $('.nav-tabs a[href="#' + url.split('#')[1] + '"]').tab('show');
            console.log("test");
        }

        // Change hash for page-reload
        $('.nav-tabs a').on('shown.bs.tab', function (e) {
            window.location.hash = e.target.hash;
        })

        //        $(document).ready(function (event) {
        //            $('ul.nav.nav-tabs a:first').tab('show'); // Select first tab
        //            $('ul.nav.nav-tabs a[href="' + window.location.hash + '"]').tab('show'); // Select tab by name if provided in location hash
        //            $('ul.nav.nav-tabs a[data-toggle="tab"]').on('shown', function (event) {    // Update the location hash to current tab
        //                window.location.hash = event.target.hash;
        //            })
        //        });

    </script>
{% endblock %}